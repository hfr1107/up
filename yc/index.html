<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <title>野草助手By路尧</title>
    <style>
        .focusable {
            transition: all 0.2s;
            outline: none;
        }
        .focusable:focus {
            outline: 3px solid #3B82F6;
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
            z-index: 10;
        }
        #software-container {
            height: 50vh;
            overflow-y: auto;
        }
        .grid-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1rem;
            padding: 1rem 0;
        }
        @media (max-width: 768px) {
            .grid-row {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center mb-6">野草助手By路尧</h1>
        
        <!-- 搜索区域 -->
        <div class="mb-6 flex flex-col md:flex-row justify-center items-center gap-2">
            <input type="text" id="search-code" 
                   class="focusable w-full md:w-64 px-4 py-2 border rounded-md text-lg"
                   placeholder="输入野草口令（如11AA）"
                   tabindex="0">
            
            <div class="flex gap-2 w-full md:w-auto">
                <button id="search-btn" 
                        class="focusable w-1/2 md:w-auto bg-blue-500 text-white px-6 py-2 rounded-md hover:bg-blue-600 text-lg"
                        tabindex="0"
                        onclick="handleSearch()">
                    立即搜索
                </button>
                
                <button id="clear-btn" 
                        class="focusable w-1/2 md:w-auto bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 text-lg"
                        tabindex="0"
                        onclick="clearSearch()">
                    清空
                </button>
            </div>
        </div>

        <!-- 分类筛选 -->
        <div class="flex flex-wrap justify-center gap-2 mb-4" id="category-buttons">
            <button class="focusable bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600" 
                    tabindex="0" onclick="filterSoftware('all')">全部</button>
        </div>

        <!-- 软件展示区 -->
        <div id="software-container" class="relative">
            <div id="software-grid" class="grid-row"></div>
        </div>
    </div>

    <script>
        let softwareData = [];
        let tagNameList = [];
        let currentCategory = 'all';
        let currentCode = '11aa';
        let focusableElements = [];
        let currentFocusIndex = 0;

        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            fetchData(currentCode);
            initKeyboardNavigation();
        });

        // 数据加载
        async function fetchData(code) {
            try {
                currentCode = code || '11aa';
                const response = await fetch(`https://hfr1107.top/api/box/yc.php?code=${currentCode}`);
                if (!response.ok) throw new Error(`网络请求失败: ${response.status}`);
                
                const data = await response.json();
                
                if (!data.groupApkList || !data.tagNameList) {
                    throw new Error('接口返回数据结构异常');
                }

                softwareData = data.groupApkList;
                tagNameList = data.tagNameList;

                initCategoryButtons();
                renderSoftware();
                updateFocusableElements();
                focusFirstGridItem();
            } catch (error) {
                console.error('数据加载错误:', error);
                document.getElementById('software-grid').innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <p class="text-red-500 text-lg">⚠️ 数据加载失败: ${error.message}</p>
                    </div>
                `;
            }
        }

        // 清空搜索
        function clearSearch() {
            document.getElementById('search-code').value = '';
            currentCode = '11aa';
            fetchData(currentCode);
        }

        // 焦点到第一个宫格
        function focusFirstGridItem() {
            const gridItems = document.querySelectorAll('.grid-item');
            if (gridItems.length > 0) {
                currentFocusIndex = Array.from(focusableElements).findIndex(el => el.classList.contains('grid-item'));
                gridItems[0].focus();
                gridItems[0].scrollIntoView({ 
                    behavior: 'auto',
                    block: 'start',
                    inline: 'center'
                });
            }
        }

        // 更新可聚焦元素
        function updateFocusableElements() {
            focusableElements = Array.from(document.querySelectorAll('.focusable'));
        }

        // 键盘导航
        function initKeyboardNavigation() {
            document.addEventListener('keydown', (e) => {
                // 返回键功能（ESC）
                if (e.key === 'Escape') {
                    e.preventDefault();
                    focusFirstGridItem();
                    return;
                }

                const activeElement = document.activeElement;
                if (!focusableElements.includes(activeElement)) return;

                switch(e.key) {
                    case 'ArrowUp':
                        moveFocus(-6);
                        break;
                    case 'ArrowDown':
                        moveFocus(6);
                        break;
                    case 'ArrowLeft':
                        moveFocus(-1);
                        break;
                    case 'ArrowRight':
                        moveFocus(1);
                        break;
                    case 'Enter':
                        activeElement.click();
                        break;
                }

                if (activeElement.classList.contains('grid-item')) {
                    activeElement.scrollIntoView({ 
                        behavior: 'auto',
                        block: 'nearest',
                        inline: 'center'
                    });
                }
            });
        }

        // 移动焦点
        function moveFocus(offset) {
            let newIndex = Math.max(0, Math.min(currentFocusIndex + offset, focusableElements.length - 1));
            let counter = 0;
            
            while (counter++ < focusableElements.length) {
                if (!focusableElements[newIndex].disabled) break;
                newIndex = offset > 0 ? newIndex + 1 : newIndex - 1;
            }

            newIndex = Math.max(0, Math.min(newIndex, focusableElements.length - 1));
            if (newIndex !== currentFocusIndex) {
                currentFocusIndex = newIndex;
                focusableElements[currentFocusIndex].focus();
            }
        }

        // 搜索处理
        function handleSearch() {
            const inputCode = document.getElementById('search-code').value;
            const sanitizedCode = inputCode.replace(/[^a-zA-Z0-9]/g, '');
            if (sanitizedCode) {
                currentCode = sanitizedCode;
                fetchData(currentCode);
            }
        }

        // 分类按钮
        function initCategoryButtons() {
            const container = document.getElementById('category-buttons');
            container.innerHTML = '<button class="focusable bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600" onclick="filterSoftware(\'all\')" tabindex="0">全部</button>';
            
            tagNameList.forEach(tag => {
                const btn = document.createElement('button');
                btn.className = 'focusable bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300';
                btn.textContent = tag;
                btn.tabIndex = 0;
                btn.onclick = () => filterSoftware(tag);
                container.appendChild(btn);
            });

            updateFocusableElements();
        }

        // 筛选逻辑
        function filterSoftware(category) {
            currentCategory = category;
            renderSoftware();
            setTimeout(() => focusFirstGridItem(), 100);
        }

        // 渲染软件列表
        function renderSoftware() {
            const grid = document.getElementById('software-grid');
            grid.innerHTML = '';

            const filtered = softwareData.filter(item => 
                currentCategory === 'all' || 
                item.tagList.some(tag => tag.tagName === currentCategory)
            );

            filtered.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'grid-item focusable bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-all';
                card.tabIndex = 0;
                card.innerHTML = `
                    <img src="${item.meta.iconUrl}" alt="${item.meta.label}" 
                         class="w-20 h-20 mx-auto mb-4 object-contain">
                    <h2 class="text-base font-bold text-center mb-2">${item.meta.label}</h2>
                    <p class="text-gray-600 text-sm text-center mb-1 truncate">${item.meta.packageName}</p>
                    <p class="text-gray-600 text-sm text-center">版本: ${item.meta.versionName}</p>
                    <a href="${item.pluginUrl}" 
                       class="block bg-blue-500 text-white px-4 py-2 rounded-md text-base text-center mt-2 hover:bg-blue-600">
                        下载
                    </a>
                `;
                grid.appendChild(card);
            });

            updateFocusableElements();
        }
    </script>
</body>
</html>
