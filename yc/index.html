<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>野草助手By路尧</title>
    <style>
        body {
            font-family: 'SimHei', sans-serif;
        }
        .focusable {
            transition: all 0.2s;
            outline: none;
        }
        .focusable:focus {
            outline: 3px solid #3B82F6;
            transform: scale(1.02);
            z-index: 10;
        }
        #software-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #software-container::-webkit-scrollbar {
            display: none;
        }
        .grid-item {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            aspect-ratio: 1/1;
        }
    </style>
</head>
<body class="bg-white">
    <div class="container mx-auto px-4 py-6">
        <h1 class="text-3xl font-bold text-center mb-8">野草助手By路尧</h1>
        
        <!-- 搜索区域 -->
        <div class="mb-8 flex flex-col md:flex-row gap-4 items-center">
            <input type="text" 
                   id="search-code" 
                   class="focusable w-full md:w-96 px-6 py-3 rounded-xl text-lg placeholder-gray-400 border border-gray-200"
                   placeholder="输入野草口令（如11AA）"
                   tabindex="0">
            
            <div class="flex gap-3 w-full md:w-auto">
                <button id="search-btn" 
                        class="focusable w-full md:w-32 bg-gray-600 text-white px-8 py-3 rounded-xl text-lg font-bold"
                        tabindex="0"
                        onclick="handleSearch()">
                    立即搜索
                </button>
                <button id="clear-btn" 
                        class="focusable w-full md:w-32 bg-gray-400 text-white px-8 py-3 rounded-xl text-lg font-bold"
                        tabindex="0"
                        onclick="clearSearch()">
                    清空
                </button>
            </div>
        </div>

        <!-- 分类标签区域 -->
        <div class="flex flex-wrap justify-center gap-3 mb-6" id="category-buttons"></div>

        <!-- 软件展示区 -->
        <div id="software-container" class="h-[75vh] overflow-y-auto">
            <div id="software-grid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 p-3"></div>
        </div>
    </div>

    <script>
        let softwareData = [];
        let tagNameList = [];
        let currentCategory = 'all';
        let currentCode = '11aa';
        let focusableElements = [];
        let currentFocusIndex = 0;

        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            fetchData(currentCode);
            initKeyboardNavigation();
        });

        // 数据加载
        async function fetchData(code) {
            try {
                const response = await fetch(`https://hfr1107.top/api/box/yc.php?code=${code || '11aa'}`);
                const data = await response.json();
                
                softwareData = data.groupApkList || [];
                tagNameList = data.tagNameList || [];
                
                initCategoryButtons();
                renderSoftware();
                updateFocusableElements();
                focusFirstGridItem();
            } catch (error) {
                document.getElementById('software-grid').innerHTML = `
                    <div class="col-span-full text-center py-8 text-red-500">
                        ⚠️ 数据加载失败: ${error.message}
                    </div>
                `;
            }
        }

        // 清空搜索
        function clearSearch() {
            document.getElementById('search-code').value = '';
            currentCode = '11aa';
            fetchData(currentCode);
        }

        // 更新可聚焦元素
        function updateFocusableElements() {
            focusableElements = Array.from(document.querySelectorAll('.focusable'));
        }

        // 焦点到第一个宫格
        function focusFirstGridItem() {
            const gridItems = document.querySelectorAll('.grid-item');
            if (gridItems.length > 0) {
                currentFocusIndex = Array.from(focusableElements).findIndex(el => el.classList.contains('grid-item'));
                gridItems[0].focus();
            }
        }

        // 键盘导航
        function initKeyboardNavigation() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    focusFirstGridItem();
                    return;
                }

                const activeElement = document.activeElement;
                if (!focusableElements.includes(activeElement)) return;

                switch(e.key) {
                    case 'ArrowUp': moveFocus(-6); break;
                    case 'ArrowDown': moveFocus(6); break;
                    case 'ArrowLeft': moveFocus(-1); break;
                    case 'ArrowRight': moveFocus(1); break;
                    case 'Enter': activeElement.click(); break;
                }
            });
        }

        // 移动焦点
        function moveFocus(offset) {
            let newIndex = Math.max(0, Math.min(currentFocusIndex + offset, focusableElements.length - 1));
            let counter = 0;
            
            while (counter++ < focusableElements.length) {
                if (!focusableElements[newIndex].disabled) break;
                newIndex = offset > 0 ? newIndex + 1 : newIndex - 1;
            }

            newIndex = Math.max(0, Math.min(newIndex, focusableElements.length - 1));
            if (newIndex !== currentFocusIndex) {
                currentFocusIndex = newIndex;
                focusableElements[currentFocusIndex].focus();
            }
        }

        // 搜索处理
        function handleSearch() {
            const inputCode = document.getElementById('search-code').value.replace(/[^a-zA-Z0-9]/g, '');
            if (inputCode) {
                currentCode = inputCode;
                fetchData(currentCode);
            }
        }

        // 初始化分类标签
        function initCategoryButtons() {
            const container = document.getElementById('category-buttons');
            container.innerHTML = `
                <button class="focusable bg-transparent text-gray-800 px-5 py-2.5 rounded-lg border border-gray-300 font-bold"
                        tabindex="0" 
                        onclick="filterSoftware('all')">
                    全部
                </button>
            `;

            tagNameList.forEach(tag => {
                const btn = document.createElement('button');
                btn.className = 'focusable bg-transparent text-gray-600 px-5 py-2.5 rounded-lg border border-gray-200 font-bold';
                btn.textContent = tag;
                btn.tabIndex = 0;
                btn.onclick = () => filterSoftware(tag);
                container.appendChild(btn);
            });

            updateFocusableElements();
        }

        // 筛选逻辑
        function filterSoftware(category) {
            currentCategory = category;
            renderSoftware();
            setTimeout(() => focusFirstGridItem(), 100);
        }

        // 宫格点击处理
        function handleGridClick(event) {
            const gridItem = event.currentTarget;
            const isFocused = (document.activeElement === gridItem);
            
            if(!isFocused) {
                gridItem.focus();
            } else {
                const downloadUrl = gridItem.querySelector('a').href;
                window.open(downloadUrl, '_blank');
            }
        }

        // 渲染软件列表（最终间距优化版）
        function renderSoftware() {
            const grid = document.getElementById('software-grid');
            grid.innerHTML = '';

            softwareData.filter(item => 
                currentCategory === 'all' || 
                item.tagList.some(tag => tag.tagName === currentCategory)
            ).forEach(item => {
                const card = document.createElement('div');
                card.className = 'grid-item focusable rounded-xl p-2';
                card.tabIndex = 0;
                card.onclick = handleGridClick;
                
                // 日期处理
                const createDate = new Date(item.createDate || Date.now());
                const dateString = createDate.toISOString().split('T')[0];

                card.innerHTML = `
                    <div class="h-full flex flex-col justify-between">
                        <div class="mb-1 flex justify-center items-center h-28">
                            <img src="${item.meta.iconUrl}" 
                                class="w-24 h-24 object-contain">
                        </div>
                        
                        <div class="space-y-0.5"> <!-- 缩小行间距 -->
                            <h3 class="text-base font-bold text-center truncate px-0.5 leading-tight">${item.meta.label}</h3>
                            <p class="text-sm text-gray-500 text-center truncate px-0.5">${item.meta.packageName}</p>
                            <div class="text-center px-0.5">
                                <div class="text-sm text-gray-600 leading-tight">v${item.meta.versionName}</div>
                                <div class="text-sm text-gray-400 leading-tight">${dateString}</div>
                            </div>
                        </div>
                        <a href="${item.pluginUrl}" class="hidden"></a>
                    </div>
                `;
                grid.appendChild(card);
            });

            updateFocusableElements();
        }
    </script>
</body>
</html>
